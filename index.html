<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .task {
            touch-action: none;
        }
        .kanban-column {
            min-height: 200px;
        }
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drag-over {
            border-style: dashed;
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Priority Colors */
        .priority-high { border-left-color: #ef4444; }
        .priority-medium { border-left-color: #f59e0b; }
        .priority-low { border-left-color: #22c55e; }
        
        /* Time remaining colors */
        .time-due { color: #22c55e; }
        .time-warning { color: #f59e0b; }
        .time-overdue { color: #ef4444; font-weight: 600; }

        /* Modal styles */
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }

        /* Stamp Animation */
        @keyframes stamp {
            0% { transform: scale(1.1); opacity: 0.8; }
            50% { transform: scale(0.95); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .stamp-animation {
            animation: stamp 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <canvas id="confetti-canvas"></canvas>

    <!-- App Container -->
    <div id="app-container" class="hidden">
        <nav class="bg-white shadow-sm p-4 flex justify-between items-center">
            <div class="flex items-center">
                <svg class="w-8 h-8 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <a href="https://github.com/imnaimur" target="_blank" rel="noopener noreferrer" class="text-xl font-bold text-gray-800 hover:text-indigo-600 transition-colors">Naimur's TM</a>
            </div>
            <div class="flex items-center">
                <img id="user-avatar" class="w-8 h-8 rounded-full mr-3" src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="User Avatar">
                <span id="user-name" class="text-sm font-medium mr-4"></span>
                <button id="sign-out-btn" class="bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-sm">Sign Out</button>
            </div>
        </nav>

        <div class="container mx-auto p-4 md:p-8">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">My Task Board</h1>
                <p class="text-gray-600 mt-2">Your tasks are saved to the cloud. Access them anywhere.</p>
            </header>

            <!-- Controls: Add Task and Search -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8 max-w-4xl mx-auto flex flex-col md:flex-row gap-4 items-center">
                <button id="open-add-task-modal-btn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm whitespace-nowrap">
                    Add New Task
                </button>
                <input type="text" id="search-input" placeholder="Search tasks..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition">
            </div>

            <!-- Kanban Board -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Columns -->
                <div id="todo" class="bg-white rounded-xl shadow-lg p-4">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b-2 border-red-500">To Do</h3>
                    <div class="kanban-column space-y-3" data-column="todo"></div>
                </div>
                <div id="inprogress" class="bg-white rounded-xl shadow-lg p-4">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 pb-2 border-b-2 border-yellow-500">In Progress</h3>
                    <div class="kanban-column space-y-3" data-column="inprogress"></div>
                </div>
                <div id="done" class="bg-white rounded-xl shadow-lg p-4">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b-2 border-green-500">
                        <h3 class="text-lg font-bold text-gray-700">Completed</h3>
                        <button id="clear-done-btn" class="text-xs text-gray-500 hover:text-red-500 transition-colors">Clear All</button>
                    </div>
                    <div class="kanban-column space-y-3" data-column="done"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-container" class="flex flex-col items-center justify-center h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-2xl">
            <div class="flex justify-center items-center mb-4">
                <svg class="w-12 h-12 text-indigo-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <h1 class="text-3xl font-bold">Naimur's TM</h1>
            </div>
            <p class="text-gray-600 mb-6">Sign in to manage your tasks from anywhere.</p>
            <button id="sign-in-btn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-lg flex items-center mx-auto">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.332,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Sign In with Google
            </button>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="modal-content bg-white rounded-xl shadow-2xl w-11/12 md:max-w-lg mx-auto p-8 z-10 transform scale-95">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add New Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="modal-task-text" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                    <input type="text" id="modal-task-text" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label for="modal-task-desc" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="modal-task-desc" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="modal-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="modal-priority" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div>
                        <label for="modal-goal-time" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="datetime-local" id="modal-goal-time" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="close-modal-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let auth, db;
        let unsubscribeTasks;
        let timeUpdateInterval;

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const columns = document.querySelectorAll('.kanban-column');
        const searchInput = document.getElementById('search-input');
        const clearDoneBtn = document.getElementById('clear-done-btn');
        
        // Modal Elements
        const taskModal = document.getElementById('task-modal');
        const openAddTaskModalBtn = document.getElementById('open-add-task-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const taskIdInput = document.getElementById('task-id');
        const modalTaskText = document.getElementById('modal-task-text');
        const modalTaskDesc = document.getElementById('modal-task-desc');
        const modalPriority = document.getElementById('modal-priority');
        const modalGoalTime = document.getElementById('modal-goal-time');

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpxTe-IykLwgoLBFNYOXLKOJVY8A9AqPQ",
            authDomain: "task-manager-e3de8.firebaseapp.com",
            projectId: "task-manager-e3de8",
            storageBucket: "task-manager-e3de8.appspot.com",
            messagingSenderId: "11010534997",
            appId: "1:11010534997:web:592f5a9932ae45dbb16edc",
            measurementId: "G-NZ9G8H2608"
        };

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = '<div class="text-center p-8 text-red-500">Error: Could not connect to the backend services. Please try again later.</div>';
        }

        // --- Authentication ---
        const provider = new GoogleAuthProvider();
        const signInWithGoogle = () => signInWithPopup(auth, provider).catch(error => console.error("Sign in error", error));
        const handleSignOut = () => signOut(auth).catch(error => console.error("Sign out error", error));

        onAuthStateChanged(auth, user => {
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userName.textContent = user.displayName;
                userAvatar.src = user.photoURL;
                loadTasks(user.uid);
                startUpdatingTime();
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeTasks) unsubscribeTasks();
                if (timeUpdateInterval) clearInterval(timeUpdateInterval);
                columns.forEach(col => col.innerHTML = '');
            }
        });

        // --- Firestore Task Management ---
        const loadTasks = (userId) => {
            const tasksCollection = collection(db, `tasks/${userId}/userTasks`);
            unsubscribeTasks = onSnapshot(tasksCollection, (snapshot) => {
                const tasksOnBoard = new Map([...document.querySelectorAll('.task')].map(t => [t.dataset.id, t]));
                const tasksInSnapshot = new Set();

                snapshot.docs.forEach(doc => {
                    const taskData = { id: doc.id, ...doc.data() };
                    tasksInSnapshot.add(doc.id);
                    const existingEl = tasksOnBoard.get(doc.id);

                    if (existingEl && existingEl.dataset.status === taskData.status) {
                        // Task exists and is in the correct column, just update its content
                        updateTaskElementContent(existingEl, taskData);
                    } else {
                        // Task is new, or has moved column
                        if (existingEl) existingEl.remove(); // Remove from old column if it exists
                        const newElement = createTaskElement(taskData);
                        const column = document.querySelector(`[data-column="${taskData.status}"]`);
                        if (column) column.appendChild(newElement);
                    }
                });

                // Remove tasks from the board that are no longer in the snapshot
                tasksOnBoard.forEach((el, id) => {
                    if (!tasksInSnapshot.has(id)) {
                        el.remove();
                    }
                });
                
                updateAllRemainingTimes();
            });
        };

        const saveTask = async (e) => {
            e.preventDefault();
            const userId = auth.currentUser?.uid;
            if (!userId) return;

            const taskId = taskIdInput.value;
            const taskData = {
                text: modalTaskText.value,
                description: modalTaskDesc.value,
                priority: modalPriority.value,
                goalTime: modalGoalTime.value ? new Date(modalGoalTime.value).toISOString() : null,
            };

            try {
                if (taskId) {
                    await updateDoc(doc(db, `tasks/${userId}/userTasks`, taskId), taskData);
                } else {
                    taskData.status = 'todo';
                    taskData.createdAt = serverTimestamp();
                    await addDoc(collection(db, `tasks/${userId}/userTasks`), taskData);
                }
                closeModal();
            } catch (error) { console.error("Error saving task:", error); }
        };

        const deleteTask = async (taskId) => {
            const userId = auth.currentUser?.uid;
            if (!userId) return;
            await deleteDoc(doc(db, `tasks/${userId}/userTasks`, taskId));
        };

        const clearDoneTasks = async () => {
            const userId = auth.currentUser?.uid;
            if (!userId) return;
            const q = query(collection(db, `tasks/${userId}/userTasks`), where("status", "==", "done"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(document => deleteDoc(doc(db, `tasks/${userId}/userTasks`, document.id)));
        };
        
        // --- UI & Task Element Creation ---
        const updateTaskElementContent = (taskEl, task) => {
             // Update dataset
            Object.keys(task).forEach(key => {
                const value = task[key];
                taskEl.dataset[key] = (value && typeof value.toDate === 'function') ? value.toDate().toISOString() : value;
            });

            // Update visible content
            taskEl.querySelector('.font-semibold').textContent = task.text;
            const descEl = taskEl.querySelector('.text-sm');
            if (task.description) {
                if (descEl) {
                    descEl.textContent = task.description;
                } else {
                    const newDescEl = document.createElement('p');
                    newDescEl.className = 'text-sm text-gray-600 mt-2';
                    newDescEl.textContent = task.description;
                    taskEl.insertBefore(newDescEl, taskEl.querySelector('.text-xs'));
                }
            } else if (descEl) {
                descEl.remove();
            }
            taskEl.className = `task p-4 bg-gray-50 rounded-lg shadow-sm cursor-grab border-l-8 hover:bg-gray-100 transition-colors priority-${task.priority}`;
            updateTaskFooter(taskEl, task);
        };

        const updateTaskFooter = (taskEl, task) => {
            const footerEl = taskEl.querySelector('.text-xs');
            if (task.status === 'done') {
                footerEl.innerHTML = `
                    <span class="font-semibold text-green-600 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Completed
                    </span>`;
            } else {
                 footerEl.innerHTML = `
                    <span class="created-time"></span>
                    <span class="remaining-time font-medium"></span>`;
            }
        };

        const createTaskElement = (task) => {
            const taskEl = document.createElement('div');
            taskEl.className = `task p-4 bg-gray-50 rounded-lg shadow-sm border-l-8 hover:bg-gray-100 transition-colors priority-${task.priority}`;
            
            Object.keys(task).forEach(key => {
                const value = task[key];
                taskEl.dataset[key] = (value && typeof value.toDate === 'function') ? value.toDate().toISOString() : value;
            });
            taskEl.dataset.id = task.id;

            if (task.status !== 'done') {
                taskEl.setAttribute('draggable', 'true');
                taskEl.classList.add('cursor-grab');
                addDragAndTouchListeners(taskEl);
            } else {
                taskEl.setAttribute('draggable', 'false');
                taskEl.classList.add('cursor-default');
            }

            taskEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-semibold flex-grow pr-2">${task.text}</p>
                    <div class="flex-shrink-0 flex items-center">
                        <button class="edit-btn text-gray-400 hover:text-indigo-500 mr-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                        </button>
                        <button class="delete-btn text-gray-400 hover:text-red-500">&times;</button>
                    </div>
                </div>
                ${task.description ? `<p class="text-sm text-gray-600 mt-2">${task.description}</p>` : ''}
                <div class="text-xs text-gray-500 mt-3 pt-2 border-t flex justify-between items-center"></div>
            `;
            
            updateTaskFooter(taskEl, task);
            taskEl.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteTask(task.id); });
            taskEl.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openEditModal(task); });
            return taskEl;
        };

        // --- Time Calculation & Display ---
        const formatTimeRemaining = (goalTime) => {
            if (!goalTime) return '';
            const diff = new Date(goalTime) - new Date();
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff / 3600000) % 24);
            const minutes = Math.floor((diff / 60000) % 60);

            if (diff < 0) return { text: 'Expired', className: 'time-overdue' };
            if (days > 1) return { text: `${days}d left`, className: 'time-due' };
            if (days === 1) return { text: `1d ${hours}h left`, className: 'time-due' };
            if (hours > 0) return { text: `${hours}h ${minutes}m left`, className: 'time-warning' };
            return { text: `${minutes}m left`, className: 'time-warning' };
        };

        const updateAllRemainingTimes = () => {
            document.querySelectorAll('.task').forEach(taskEl => {
                if (taskEl.dataset.status === 'done') return;
                const createdAt = taskEl.dataset.createdAt;
                const goalTime = taskEl.dataset.goalTime;
                
                const createdEl = taskEl.querySelector('.created-time');
                if (createdEl && createdAt && createdAt !== 'null') {
                    createdEl.textContent = `Created: ${new Date(createdAt).toLocaleDateString()}`;
                }
                
                const remainingEl = taskEl.querySelector('.remaining-time');
                if (remainingEl && goalTime && goalTime !== 'null') {
                    const { text, className } = formatTimeRemaining(goalTime);
                    remainingEl.textContent = text;
                    remainingEl.className = `remaining-time font-medium ${className}`;
                }
            });
        };

        const startUpdatingTime = () => {
            if (timeUpdateInterval) clearInterval(timeUpdateInterval);
            timeUpdateInterval = setInterval(updateAllRemainingTimes, 60000);
        };

        // --- Drag, Drop, Touch & Animations ---
        let draggedItem = null;
        let touchStartX, touchStartY;

        const addDragAndTouchListeners = (el) => {
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragend', handleDragEnd);
            el.addEventListener('touchstart', handleTouchStart, { passive: false });
            el.addEventListener('touchmove', handleTouchMove, { passive: false });
            el.addEventListener('touchend', handleTouchEnd);
        };

        const applyDropAnimation = (element, status) => {
            if (status === 'todo' || status === 'inprogress') {
                element.classList.add('stamp-animation');
                element.addEventListener('animationend', () => {
                    element.classList.remove('stamp-animation');
                }, { once: true });
            }
        };

        function handleDragStart(e) {
            draggedItem = this;
            setTimeout(() => this.classList.add('dragging'), 0);
        }
        function handleDragEnd() { this.classList.remove('dragging'); }

        columns.forEach(column => {
            column.addEventListener('dragover', e => { e.preventDefault(); column.classList.add('drag-over'); });
            column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
            column.addEventListener('drop', handleDrop);
        });

        async function handleDrop() {
            if (!draggedItem) return;
            this.classList.remove('drag-over');
            const newStatus = this.dataset.column;
            
            applyDropAnimation(draggedItem, newStatus);

            const userId = auth.currentUser?.uid;
            const taskId = draggedItem.dataset.id;
            if (!userId || !taskId) return;
            
            const updateData = { status: newStatus };
            if (newStatus === 'done') {
                updateData.completedAt = serverTimestamp();
            }
            await updateDoc(doc(db, `tasks/${userId}/userTasks`, taskId), updateData);
            if (newStatus === 'done') triggerConfetti();
        }

        function handleTouchStart(e) {
            draggedItem = this;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            const rect = draggedItem.getBoundingClientRect();
            draggedItem.style.width = `${rect.width}px`;
            draggedItem.style.height = `${rect.height}px`;
            draggedItem.style.position = 'fixed';
            draggedItem.style.left = `${touchStartX - (e.touches[0].clientX - rect.left)}px`;
            draggedItem.style.top = `${touchStartY - (e.touches[0].clientY - rect.top)}px`;
            draggedItem.style.pointerEvents = 'none';
            draggedItem.style.zIndex = '100';
            draggedItem.classList.add('dragging');
        }
        function handleTouchMove(e) {
            e.preventDefault();
            if (!draggedItem) return;
            const touch = e.touches[0];
            draggedItem.style.left = `${draggedItem.offsetLeft + (touch.clientX - touchStartX)}px`;
            draggedItem.style.top = `${draggedItem.offsetTop + (touch.clientY - touchStartY)}px`;
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;

            draggedItem.style.display = 'none';
            const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
            draggedItem.style.display = '';
            
            columns.forEach(col => col.classList.remove('drag-over'));
            const dropZone = elementUnderTouch?.closest('.kanban-column');
            if (dropZone) dropZone.classList.add('drag-over');
        }
        async function handleTouchEnd(e) {
            if (!draggedItem) return;
            draggedItem.style.position = '';
            draggedItem.style.width = '';
            draggedItem.style.height = '';
            draggedItem.style.left = '';
            draggedItem.style.top = '';
            draggedItem.style.pointerEvents = '';
            draggedItem.style.zIndex = '';
            draggedItem.classList.remove('dragging');

            const touch = e.changedTouches[0];
            const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
            columns.forEach(col => col.classList.remove('drag-over'));
            const dropZone = elementUnderTouch?.closest('.kanban-column');
            if (dropZone) {
                const newStatus = dropZone.dataset.column;
                applyDropAnimation(draggedItem, newStatus);

                const userId = auth.currentUser?.uid;
                const taskId = draggedItem.dataset.id;
                if (!userId || !taskId) return;
                
                const updateData = { status: newStatus };
                if (newStatus === 'done') {
                    updateData.completedAt = serverTimestamp();
                }
                await updateDoc(doc(db, `tasks/${userId}/userTasks`, taskId), updateData);
                if (newStatus === 'done') triggerConfetti();
            }
            draggedItem = null;
        }

        // --- Modal ---
        const openModal = () => {
            taskModal.classList.remove('hidden');
            taskModal.classList.add('flex');
            setTimeout(() => {
                taskModal.querySelector('.modal-backdrop').classList.remove('opacity-0');
                taskModal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        };
        const closeModal = () => {
            taskModal.querySelector('.modal-backdrop').classList.add('opacity-0');
            taskModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                taskModal.classList.add('hidden');
                taskModal.classList.remove('flex');
            }, 300);
        };
        const openAddTaskModal = () => {
            taskForm.reset();
            taskIdInput.value = '';
            modalTitle.textContent = 'Add New Task';
            modalPriority.value = 'medium';
            openModal();
        };
        const openEditModal = (task) => {
            taskForm.reset();
            modalTitle.textContent = 'Edit Task';
            taskIdInput.value = task.id;
            modalTaskText.value = task.text;
            modalTaskDesc.value = task.description || '';
            modalPriority.value = task.priority || 'medium';
            if (task.goalTime) {
                const date = new Date(task.goalTime);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                modalGoalTime.value = date.toISOString().slice(0, 16);
            }
            openModal();
        };

        // --- Search ---
        const filterTasks = () => {
            const query = searchInput.value.toLowerCase();
            document.querySelectorAll('.task').forEach(taskEl => {
                const text = (taskEl.dataset.text || '').toLowerCase();
                const desc = (taskEl.dataset.description || '').toLowerCase();
                taskEl.style.display = (text.includes(query) || desc.includes(query)) ? '' : 'none';
            });
        };

        // --- Event Listeners ---
        signInBtn.addEventListener('click', signInWithGoogle);
        signOutBtn.addEventListener('click', handleSignOut);
        openAddTaskModalBtn.addEventListener('click', openAddTaskModal);
        closeModalBtn.addEventListener('click', closeModal);
        taskModal.querySelector('.modal-backdrop').addEventListener('click', closeModal);
        taskForm.addEventListener('submit', saveTask);
        searchInput.addEventListener('input', filterTasks);
        clearDoneBtn.addEventListener('click', clearDoneTasks);

        // --- Confetti ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let confettiParticles = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        function triggerConfetti() {
            confettiParticles = [];
            for (let i = 0; i < 150; i++) confettiParticles.push({ x: Math.random() * canvas.width, y: -Math.random() * canvas.height * 0.5, size: Math.random() * 5 + 2, speed: Math.random() * 3 + 2, angle: Math.random() * Math.PI * 2, color: `hsl(${Math.random() * 360}, 100%, 50%)`, rotation: Math.random() * 360, rotationSpeed: (Math.random() - 0.5) * 10 });
            animateConfetti();
        }
        let animationFrameId;
        function animateConfetti() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let activeParticles = false;
            confettiParticles.forEach(p => {
                p.y += p.speed; p.x += Math.sin(p.angle) * 0.5; p.rotation += p.rotationSpeed;
                if (p.y < canvas.height) {
                    activeParticles = true;
                    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color; ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();
                }
            });
            if (activeParticles) animationFrameId = requestAnimationFrame(animateConfetti);
            else cancelAnimationFrame(animationFrameId);
        }
    </script>
</body>
</html>
